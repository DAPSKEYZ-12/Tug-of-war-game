<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Escape | Lab 404</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff003c;
            --neon-green: #00ff88;
            --bg-dark: #0a0a0c;
            --panel-bg: rgba(20, 20, 25, 0.9);
        }

        body {
            margin: 0;
            background: var(--bg-dark);
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .center-screen {
            width: 100%;
            max-width: 800px;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .auth-panel,
        .terminal {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--neon-blue);
            text-align: center;
            width: 350px;
            z-index: 5;
            box-sizing: border-box;
        }

        .auth-title {
            margin-top: 0;
            margin-bottom: 8px;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .auth-subtitle {
            margin-bottom: 18px;
            color: #c9f8ff;
            font-size: 0.95rem;
        }

        .auth-field {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            box-sizing: border-box;
            background: #000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            font-size: 1rem;
            outline: none;
        }

        .auth-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .auth-status {
            margin-top: 12px;
            min-height: 22px;
            color: var(--neon-green);
            font-size: 0.9rem;
        }

        .muted-btn {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
        }

        /* Game Container */
        #game-stage {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 600px;
            background: radial-gradient(circle, #1a1a2e 0%, #000 100%);
            border: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        /* HUD - Top Bar */
        .hud {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--neon-blue);
            z-index: 10;
            gap: 12px;
        }

        .stat-box { font-weight: bold; letter-spacing: 1px; }
        #timer-display { color: var(--neon-red); }

        .hud-user {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* The Door Visuals */
        .door-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            position: relative;
        }

        #door {
            width: 200px;
            height: 300px;
            background: #222;
            border: 4px solid #444;
            border-radius: 10px;
            position: relative;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        }

        .door-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--neon-red);
            margin-bottom: 20px;
            box-shadow: 0 0 10px var(--neon-red);
        }

        /* Animations */
        .unlocking {
            transform: rotateY(-110deg) translateX(-50px);
            border-color: var(--neon-green) !important;
        }

        .shake {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Terminal UI */
        #equation {
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        input {
            background: #000;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px;
            font-size: 1.2rem;
            width: 80px;
            text-align: center;
            outline: none;
        }

        button {
            background: var(--neon-blue);
            color: black;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover { background: white; box-shadow: 0 0 15px var(--neon-blue); }

        /* Overlay Systems */
        #overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .leaderboard-wrap {
            margin-top: 20px;
            color: var(--neon-blue);
            width: min(500px, 90%);
            display: grid;
            gap: 14px;
        }

        .leaderboard-card {
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            padding: 10px;
            background: rgba(0, 20, 30, 0.4);
        }

        .leaderboard-card h4 {
            margin: 0 0 8px;
        }

        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed rgba(0, 243, 255, 0.2);
            font-size: 0.9rem;
        }

        .leaderboard-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

<div class="center-screen" id="auth-gate">
    <div class="auth-panel">
        <h2 class="auth-title">LAB 404 AUTH</h2>
        <div class="auth-subtitle">Login or create an agent profile to unlock the game.</div>
        <input class="auth-field" id="auth-user" type="text" autocomplete="username" maxlength="24" placeholder="Agent ID">
        <input class="auth-field" id="auth-pass" type="password" autocomplete="current-password" maxlength="64" placeholder="Passcode">
        <div class="auth-actions">
            <button id="login-btn">LOGIN</button>
            <button id="register-btn" class="muted-btn">REGISTER</button>
        </div>
        <div class="auth-status" id="auth-status"></div>
    </div>
</div>

<div id="game-stage">
    <div class="hud">
        <div class="stat-box">SEC_LEVEL: <span id="level">1</span></div>
        <div class="stat-box">STABILITY: <span id="timer-display">30</span>s</div>
        <div class="stat-box">SCORE: <span id="score">0</span></div>
        <div class="hud-user">
            <div class="stat-box" id="active-user">AGENT: -</div>
            <button class="muted-btn" id="logout-btn">LOGOUT</button>
        </div>
    </div>

    <div class="door-container">
        <div id="door">
            <div class="door-light" id="status-light"></div>
            <div id="scanner-line"></div>
        </div>

        <div class="terminal" id="main-ui">
            <h3 id="story-text">DECRYPT TO ESCAPE</h3>
            <div id="equation">3x - 5 = 10</div>
            <input type="number" id="ans-input" placeholder="?">
            <button onclick="game.check()">UNLOCK</button>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title">SYSTEM FAILURE</h1>
        <p>Agent <span id="final-user">-</span> score: <span id="final-score">0</span></p>
        <button onclick="location.reload()">REBOOT SYSTEM</button>
        <div class="leaderboard-wrap">
            <div class="leaderboard-card" id="leaderboard-global"></div>
            <div class="leaderboard-card" id="leaderboard-history"></div>
        </div>
    </div>
</div>

<script>
class PerformanceDatabase {
    constructor() {
        this.db = null;
    }

    async init() {
        this.db = await new Promise((resolve, reject) => {
            const request = indexedDB.open('algebra_escape_lab404', 1);
            request.onupgradeneeded = () => {
                const db = request.result;
                if (!db.objectStoreNames.contains('users')) {
                    db.createObjectStore('users', { keyPath: 'username' });
                }
                if (!db.objectStoreNames.contains('performances')) {
                    const store = db.createObjectStore('performances', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('byScore', 'score', { unique: false });
                    store.createIndex('byUser', 'username', { unique: false });
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    transaction(storeNames, mode = 'readonly') {
        return this.db.transaction(storeNames, mode);
    }

    async getUser(username) {
        return new Promise((resolve, reject) => {
            const req = this.transaction(['users']).objectStore('users').get(username);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = () => reject(req.error);
        });
    }

    async createUser(user) {
        return new Promise((resolve, reject) => {
            const req = this.transaction(['users'], 'readwrite').objectStore('users').add(user);
            req.onsuccess = () => resolve(true);
            req.onerror = () => reject(req.error);
        });
    }

    async savePerformance(run) {
        return new Promise((resolve, reject) => {
            const req = this.transaction(['performances'], 'readwrite').objectStore('performances').add(run);
            req.onsuccess = () => resolve(true);
            req.onerror = () => reject(req.error);
        });
    }

    async getAllPerformances() {
        return new Promise((resolve, reject) => {
            const req = this.transaction(['performances']).objectStore('performances').getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => reject(req.error);
        });
    }

    async getTopLeaderboard(limit = 5) {
        const data = await this.getAllPerformances();
        return data.sort((a, b) => b.score - a.score).slice(0, limit);
    }

    async getUserHistory(username, limit = 5) {
        const data = await this.getAllPerformances();
        return data
            .filter((run) => run.username === username)
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, limit);
    }
}

class AuthService {
    constructor(database) {
        this.database = database;
        this.sessionKey = 'algebra_escape_session';
    }

    async hash(password) {
        const encoded = new TextEncoder().encode(password);
        const digest = await crypto.subtle.digest('SHA-256', encoded);
        return Array.from(new Uint8Array(digest)).map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    cleanUsername(username) {
        return username.trim().toLowerCase().replace(/[^a-z0-9_-]/g, '').slice(0, 24);
    }

    async register(username, password) {
        const user = this.cleanUsername(username);
        if (!user || password.length < 6) {
            throw new Error('Use a valid Agent ID and passcode (min 6 chars).');
        }

        const existing = await this.database.getUser(user);
        if (existing) {
            throw new Error('Agent ID already exists. Please login.');
        }

        await this.database.createUser({
            username: user,
            passwordHash: await this.hash(password),
            createdAt: Date.now()
        });

        localStorage.setItem(this.sessionKey, user);
        return user;
    }

    async login(username, password) {
        const user = this.cleanUsername(username);
        const record = await this.database.getUser(user);
        if (!record) {
            throw new Error('Unknown Agent ID. Register first.');
        }

        const submittedHash = await this.hash(password);
        if (record.passwordHash !== submittedHash) {
            throw new Error('Invalid passcode.');
        }

        localStorage.setItem(this.sessionKey, user);
        return user;
    }

    getSession() {
        return localStorage.getItem(this.sessionKey);
    }

    logout() {
        localStorage.removeItem(this.sessionKey);
    }
}

class AlgebraGame {
    constructor(username, database) {
        this.username = username;
        this.database = database;
        this.level = 1;
        this.score = 0;
        this.timeLeft = 30;
        this.currentSolution = 0;
        this.timer = null;
        this.isGameOver = false;
        this.elapsedSeconds = 0;

        this.init();
    }

    init() {
        this.nextLevel();
        this.startTimer();
        document.getElementById('active-user').innerText = `AGENT: ${this.username}`;
    }

    startTimer() {
        this.timer = setInterval(() => {
            this.timeLeft--;
            this.elapsedSeconds++;
            document.getElementById('timer-display').innerText = this.timeLeft;
            if (this.timeLeft <= 0) this.endGame();
        }, 1000);
    }

    generateEquation() {
        const a = Math.floor(Math.random() * (2 + this.level)) + 2;
        const x = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 15) + 1;

        const isAddition = Math.random() > 0.5;
        const c = isAddition ? (a * x) + b : (a * x) - b;

        this.currentSolution = x;
        return `${a}x ${isAddition ? '+' : '-'} ${b} = ${c}`;
    }

    check() {
        if (this.isGameOver) return;

        const input = document.getElementById('ans-input');
        const door = document.getElementById('door');
        const light = document.getElementById('status-light');

        if (parseInt(input.value, 10) === this.currentSolution) {
            this.score += 10 + this.timeLeft;
            this.level++;
            this.timeLeft += 10;

            light.style.background = 'var(--neon-green)';
            light.style.boxShadow = '0 0 15px var(--neon-green)';
            door.classList.add('unlocking');

            setTimeout(() => {
                door.classList.remove('unlocking');
                light.style.background = 'var(--neon-red)';
                light.style.boxShadow = '0 0 10px var(--neon-red)';
                this.nextLevel();
                input.value = '';
            }, 1000);
        } else {
            door.classList.add('shake');
            setTimeout(() => door.classList.remove('shake'), 400);
            this.timeLeft -= 5;
        }
    }

    nextLevel() {
        document.getElementById('level').innerText = this.level;
        document.getElementById('score').innerText = this.score;
        document.getElementById('equation').innerText = this.generateEquation();
    }

    async endGame() {
        this.isGameOver = true;
        clearInterval(this.timer);
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('final-score').innerText = this.score;
        document.getElementById('final-user').innerText = this.username;

        await this.database.savePerformance({
            username: this.username,
            score: this.score,
            levelReached: this.level,
            durationSec: this.elapsedSeconds,
            timestamp: Date.now()
        });

        await this.updateLeaderboardDisplay();
    }

    async updateLeaderboardDisplay() {
        const topRuns = await this.database.getTopLeaderboard(5);
        const history = await this.database.getUserHistory(this.username, 5);

        const topHtml = topRuns.length
            ? topRuns.map((run, i) => (
                `<div class="leaderboard-row"><span>#${i + 1} ${run.username}</span><span>${run.score} pts</span></div>`
            )).join('')
            : '<div>No runs yet.</div>';

        const historyHtml = history.length
            ? history.map((run) => (
                `<div class="leaderboard-row"><span>L${run.levelReached} · ${run.durationSec}s</span><span>${run.score} pts</span></div>`
            )).join('')
            : '<div>No history yet.</div>';

        document.getElementById('leaderboard-global').innerHTML = `<h4>GLOBAL TOP AGENTS</h4>${topHtml}`;
        document.getElementById('leaderboard-history').innerHTML = `<h4>${this.username.toUpperCase()} · RECENT RUNS</h4>${historyHtml}`;
    }
}

let game = null;

(async () => {
    const db = new PerformanceDatabase();
    await db.init();
    const auth = new AuthService(db);

    const authGate = document.getElementById('auth-gate');
    const gameStage = document.getElementById('game-stage');
    const authStatus = document.getElementById('auth-status');
    const usernameInput = document.getElementById('auth-user');
    const passInput = document.getElementById('auth-pass');

    const showGame = (username) => {
        authGate.style.display = 'none';
        gameStage.style.display = 'flex';
        game = new AlgebraGame(username, db);
    };

    const handleAuth = async (mode) => {
        try {
            const username = usernameInput.value;
            const password = passInput.value;
            const user = mode === 'register'
                ? await auth.register(username, password)
                : await auth.login(username, password);

            authStatus.style.color = 'var(--neon-green)';
            authStatus.innerText = `Access granted, Agent ${user}.`;
            setTimeout(() => showGame(user), 250);
        } catch (err) {
            authStatus.style.color = 'var(--neon-red)';
            authStatus.innerText = err.message || 'Authentication failed.';
        }
    };

    document.getElementById('login-btn').addEventListener('click', () => handleAuth('login'));
    document.getElementById('register-btn').addEventListener('click', () => handleAuth('register'));
    document.getElementById('logout-btn').addEventListener('click', () => {
        auth.logout();
        location.reload();
    });

    document.addEventListener('keypress', (e) => {
        if (authGate.style.display !== 'none' && e.key === 'Enter') {
            handleAuth('login');
        } else if (e.key === 'Enter' && game) {
            game.check();
        }
    });

    const existingSession = auth.getSession();
    if (existingSession) {
        showGame(existingSession);
    }
})();
</script>
</body>
</html>
